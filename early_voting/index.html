<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Early voting in Minnesota</title>
  <meta name="description" content="Early voting in Minnesota">
  <meta name="author" content="Frey Hargarten - StarTribune">

  <link rel="stylesheet" href="../_common_resources/styles/startribune_dataviz_styles.css" />
  <link href="../_common_resources/charts/c3-master/c3.css" rel="stylesheet" type="text/css">
  
  <style>
    body, p, text, td { font-family:"Benton Sans",Helvetica,Arial,sans-serif !important; }
    #wrapper { width:540px; margin-left:auto; margin-right:auto; }
    .map { display:inline-block; width:48%; text-align:center; }
    .quantize {  }
    path:hover { cursor:default !important; }
    .hottest { fill:#a70518; }

    /*SWATCHES*/
    .republican text { background-color:#bbb; fill:#8C1B17 !important; pointer-events: all; color:#8C1B17; }
    .republican line { background-color:#8C1B17; fill:#8C1B17 !important; stroke:#8C1B17 !important; pointer-events: all; color:#8C1B17; }
    .mid { background-color:#aaa; fill:#aaa !important; color:black !important; pointer-events: all; font-weight:bold; }
    .democrat text { background-color:#3F88C5; fill:#3F88C5 !important; pointer-events: all; color:#3F88C5;  }
    .democrat line { background-color:#3F88C5; fill:#3F88C5 !important; stroke:#3F88C5 !important; pointer-events: all; color:#3F88C5;  }
    .countyName { font-weight:bold; }

    .chart { display:inline-block; width:100%; text-align:center;}
    .chartTitle { text-align:left; }
    .chatter { text-align:left !important; font-size:0.8em; }

    #compareChart .c3-line, #dateChart .c3-line { stroke-width:5px !important; }
    #compare { display:none !important; }

    .purple5 { fill:#4c1926; background-color:#4c1926; color:#ffffff; }
    .purple4 { fill:#693c46; background-color:#693c46; color:#ffffff; }
    .purple3 { fill:#865f67; background-color:#865f67; color:#ffffff; }
    .purple2 { fill:#a3858b; background-color:#a3858b; color:#ffffff; }
    .purple1 { fill:#C1ACB1; background-color:#C1ACB1; }

    .source{ clear:both; text-align:left; padding-top:5px; }

    .map { text-align:center; }

    #countyChart { height:1200px; }
    .null { /*fill-opacity:0 !important;*/ fill:#fff !important; }
    #mapPrecinct path, #mapMetro path { pointer-events:none !important; }

    @media (max-width:520px) { 
      #wrapper { width:100%; }
      .map { display:block; width:100%; text-align:center; }
      .quantize { padding-left:72px; }
      .metro { display:none; }
    }
  </style> 
</head>

<!-- 399366901 -->

<body>
<div id="wrapper">

<div class="chart" id="pct">
<div class="chartTitle">Where 2016 absentee votes came from by precinct</div>
<div class="chatter">On a precinct level, a lot of absentee votes have come out of Minneapolis and the surrounding area.</div>
<div id="mapPrecinct" class="map"><svg width="320" height="350" viewBox="0 0 500 550" preserveAspectRatio="xMidYMid"></svg></div>
<div id="mapMetro" class="map"><svg width="320" height="350" viewBox="0 0 500 550" preserveAspectRatio="xMidYMid"></svg></div>

<div class="quantize">
<span class='legend' id="aidQ">
  <nav class='legend clearfix'>
    <span style='background:#fff;'>Less</span>
    <span class="purple1"></span>
    <span class="purple2"></span>
    <span class="purple3"></span>
    <span class="purple4"></span>
    <span class="purple5"></span>
    <span style='background:#fff;'>More</span>
</span>
</div>
</div>


<div class="chart" id="compare">
<div class="chartTitle">When 2016 absentee voters first registered to vote</div>

<div id="compareChart"></div>
<div class="source">Source: Star Tribune analysis, Minnesota Secretary of State</div>
</div>

<div class="chart" id="region">
<div class="chartTitle">Share of absentee votes by region</div>
<div class="chatter">Of the 524,964 absentee ballots accepted across Minnesota, about 41 percent came from Hennepin and Ramsey counties -- higher than the 33 percent of votes cast in these counties during the 2012 presidential elections. Meanwhile, the outer suburbs are voting at slightly lower rates, with 7 percent of absentee ballots coming from outer-rung areas, compared to their 10 percent share of presidential votes in 2012.</div>
<div id="regionChart"></div>
<div class="chatter">Remainder of 7-county metro: Anoka, Dakota, Washington, Scott and Carver counties.</div>
<div class="chatter">Outer suburbs: Rice, Benton, Chisago, Goodhue, Isanti, Le Sueur, Mille Lacs, Wright, McLeod, Sherburne, Sibley.</div>
<div class="source">Source: Star Tribune analysis, Minnesota Secretary of State</div>
</div>

<div class="chart" id="county">
<div class="chartTitle">Percentage of registered voters sending absentee ballots by county</div>
<div class="chatter">As a percentage of registered voters, northern rural counties tend to have higher rates of early voting than many other places in Minnesota.</div>
<div id="mapCounties" class="map"><svg width="320" height="350" viewBox="0 0 500 550" preserveAspectRatio="xMidYMid"></svg></div>

<div class="quantize">
<span class='legend' id="aidQ">
  <nav class='legend clearfix'>
    <span style='background:#fff;'>Less</span>
    <span class="purple1"></span>
    <span class="purple2"></span>
    <span class="purple3"></span>
    <span class="purple4"></span>
    <span class="purple5"></span>
    <span style='background:#fff;'>More</span>
</span>
</div>
<div class="source">Source: Star Tribune analysis, Minnesota Secretary of State</div>
</div>

<div class="chart" id="date">
<div class="chartTitle">Accepted absentee ballots by date range</div>
<div class="chatter">Since the beginning of Minnesotaâ€™s early voting in September, the number of accepted ballots has steadily increased as Election Day approaches.</div>
<div id="dateChart"></div>
<div class="source">Source: Star Tribune analysis, Minnesota Secretary of State</div>
</div>

<div class="chart" id="age">
<div class="chartTitle">Voters by age group, all registered versus absentee</div>
<div class="chatter">Absentee voters tend to be older, more often 55-plus. But in the final two weeks, more younger voters started casting ballots.</div>
<div id="ageChart"></div>
<div class="source">Source: Star Tribune analysis, Minnesota Secretary of State</div>
</div>

</div>

</div>
</body>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
<script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="../_common_resources/charts/c3-master/c3.min.js"></script>
<script>

$.urlParam = function(name){
  var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
  if (results != null) { return results[1] || 0; }
  else { return null; }
}

var selected = $.urlParam('chart');

if (selected != null){
$(".chart").hide();
$("#" + selected).show();
} else { $(".chart").show(); }

d3.csv("./data/votes.csv", function(d) {
  return {
    votes: +d.votes,
    vtd: d.vtdcode
  };
}, function(error, rows) {

d3.csv("./data/counties.csv", function(d) {
  return {
    pct: +d.pct,
    county: d.county
  };
}, function(error, rows2) {

var data = rows;
var dataC = rows2;

function mapBuild(container, boxContainer, chartContainer, shape, race, geo, dataCompare, index) {

var width = 600,
    height = 800,
    centered;

if (geo=="us") { var projection = d3.geo.albersUsa().scale(700).translate([330, 200]); }
else if (geo=="mn") { var projection = d3.geo.albersUsa().scale(5037).translate([50, 970]); }
else if (geo=="metro") { var projection = d3.geo.mercator().scale([21000]).center([-92.7,45.059134]); }

var path = d3.geo.path()
    .projection(projection);

var svg = d3.select(container + " svg")
    .attr("width", width)
    .attr("height", height);

svg.append("rect")
    .attr("class", "background")
    .attr("width", width)
    .attr("height", height);

var g = svg.append("g");

d3.json("shapefiles/" + shape, function(error, us) {

  g.append("g")
      .attr("class", "states")
    .selectAll("path")
      .data(us.features)
    .enter().append("path")
      .attr("d", path)
      // .on("click", clicked)
      .attr("id", function(d) { return d.properties.county_id; })
      .attr("class", function(d){
        if (race == "counties"){
        for (var i=0; i < dataC.length; i++){
          if (dataC[i].county == d.properties.COUNTYNAME){
            if (dataC[i].pct >= .40){ return "purple5"; }
            else if (dataC[i].pct >= .30){ return "purple4"; }
            else if (dataC[i].pct >= .20){ return "purple3"; }
            else if (dataC[i].pct >= .10){ return "purple2"; }
            else if (dataC[i].pct >= 0){ return "purple1"; }
          }
        }   
        }
        if (race == "precinct"){
        for (var i=0; i<data.length; i++){
          if (data[i].vtd == d.properties.VTDID){
            if (data[i].votes >= 400){ return "purple5"; }
            else if (data[i].votes >= 320){ return "purple4"; }
            else if (data[i].votes >= 240){ return "purple3"; }
            else if (data[i].votes >= 160){ return "purple2"; }
            else if (data[i].votes >= 0){ return "purple1"; }
          }
        }
       }
        return "null";
       })
      .style("stroke-width", function(d, i){
        if (race == "counties"){ return "0.5px" }
        else { return "0"; }
        })
      .style("stroke", "#bbb")
      .call(d3.helper.tooltip(function(d, i){
        if (race == "counties"){
        for (var i=0; i < dataC.length; i++){
            if (dataC[i].pct >= .18){ var color = "purple5"; }
            else if (dataC[i].pct >= .15){ var color = "purple4"; }
            else if (dataC[i].pct >= .10){ var color = "purple3"; }
            else if (dataC[i].pct >= .05){ var color = "purple2"; }
            else if (dataC[i].pct >= 0){ var color = "purple1"; }

          if (dataC[i].county == d.properties.COUNTYNAME){
            return "<div class='countyName'>" + d.properties.COUNTYNAME + " County</div><div class='" + color + "'>" + d3.format("%")(dataC[i].pct) + " absentee voters</div>"
          }
        }  
        return "<div class='countyName'>" + d.properties.COUNTYNAME + " County</div><div>No data</div>"; 
        }
      }));

  g.append("path")
      //.datum(topojson.mesh(us, us.features, function(a, b) { return a !== b; }))
      .attr("id", "state-borders")
      .attr("d", path);

});

// d3.json("shapefiles/counties.json", function(error, us) {

//   g.append("g")
//       .attr("class", "states")
//     .selectAll("path")
//       .data(us.features)
//     .enter().append("path")
//       .attr("d", path)
//       .attr("class", "null")
//       .style("stroke-width", "2px")
//       .style("stroke", "#000");

//   g.append("path")
//       .attr("id", "state-borders")
//       .attr("d", path);

// });

var zoom = d3.behavior.zoom()
    .on("zoom",function() {
        g.attr("transform","translate("+ 
            d3.event.translate.join(",")+")scale("+d3.event.scale+")");
        g.selectAll("circle")
            .attr("d", path.projection(projection));
        g.selectAll("path")  
            .attr("d", path.projection(projection)); 

  });

$(".zoom, .switch, #close, .mapSwitch").click(function() {
  clicked2();
});

function clicked(d) {
  var x, y, k;

  if (d && centered !== d) {
    var centroid = path.centroid(d);
    x = centroid[0];
    y = centroid[1];
    k = 6;
    centered = d;
  } else {
    x = width / 2;
    y = height / 2;
    k = 3;
    centered = null;
  }

  d3.selectAll("#mapMetro path, #mapState path")
      .classed("faded", false)
      .classed("active", false);

  g.selectAll("path")
      .classed("faded", true)
      .classed("active", centered && function (d) { return d === centered; });
}

function clicked2(d) {
  var x, y, k;

  if (d && centered !== d) {
    var centroid = path.centroid(d);
    x = centroid[0];
    y = centroid[1];
    k = 1;
    centered = d;
  } else {
    x = width / 2;
    y = height / 2;
    k = 1;
    centered = null;
  }

  g.selectAll("path")
      .classed("faded", false)
      .classed("active", centered && function (d) { return d === centered; });
}

d3.helper = {};

d3.helper.tooltip = function(accessor){
    return function(selection){
        var tooltipDiv;
        var bodyNode = d3.select('body').node();
        selection.on("mouseover", function(d, i){
            // Clean up lost tooltips
            d3.select('body').selectAll('div.tooltip').remove();
            // Append tooltip
            tooltipDiv = d3.select('body').append('div').attr('class', 'tooltip');
            var absoluteMousePos = d3.mouse(bodyNode);
            tooltipDiv.style('left', (absoluteMousePos[0] - 160)+'px')
                .style('top', (absoluteMousePos[1] - 15)+'px')
                .style('position', 'absolute')
                .style('z-index', 1001);
            // Add text using the accessor function
            var tooltipText = accessor(d, i) || '';
            // Crop text arbitrarily
            //tooltipDiv.style('width', function(d, i){return (tooltipText.length > 80) ? '300px' : null;})
            //    .html(tooltipText);
        })
        .on('mousemove', function(d, i) {
            // Move tooltip
            var absoluteMousePos = d3.mouse(bodyNode);
            tooltipDiv.style('left', (absoluteMousePos[0] - 160)+'px')
                .style('top', (absoluteMousePos[1] - 15)+'px');
            var tooltipText = accessor(d, i) || '';
            tooltipDiv.html(tooltipText);
        })
        .on("mouseout", function(d, i){
            // Remove tooltip
            tooltipDiv.remove();
        });

    };
};


var aspect = 600 / 800, chart = $(container + " svg"); //, chart2 = $(".carto svg")
$(document).ready(function() {
  var targetWidth = chart.parent().width();
  chart.attr("width", targetWidth);
  chart.attr("height", targetWidth / aspect);
});

$(window).on("resize", function() {
  chart.attr("style","");
  var targetWidth = chart.parent().width();
  chart.attr("width", targetWidth);
  chart.attr("height", targetWidth / aspect);
});

}



mapBuild("#mapPrecinct", "#infobox", "#chart", "mnprecincts.json", "precinct", "mn", data, 0);
mapBuild("#mapMetro", "#infobox", "#chart", "metro_precincts.json", "precinct", "metro", data, 0);
mapBuild("#mapCounties", "#infobox", "#chart", "counties.json", "counties", "mn", dataC, 0);

//region
function chartRegion(){

var  padding = {
        top: 20,
        right: 60,
        bottom: 20,
        left: 120,
    };

var chartPop = c3.generate({
      bindto: "#regionChart",
      padding: padding,
      data: {
            columns: [
                ['Presidential Voting 2012', .33, .23, .10, .09, .25],
                ['Absentee Ballots 2016', .41, .23, .07, .07, .23]
            ],
        type: 'bar'
        },
        // legend: {
        //     show: false
        // },
            color: {
              pattern: ['#333','#865f67']
            },
        axis: {
              rotated: true,
              y: {
                    min: 0,
                    padding: {bottom: 0},
                    tick: {
                     count: 4,
                     format: d3.format('%')
                    }
                },
            x: {
                type: 'category',
                categories: ['Hennepin/Ramsey counties','Rest of 7 county','Outer suburbs','Rochester-St.Cloud-Duluth','Remainder of outstate']
            }
        }
});

}

chartRegion();

//age
function chartAge(){

var  padding = {
        top: 20,
        right: 60,
        bottom: 20,
        left: 120,
    };

var chartPop = c3.generate({
      bindto: "#ageChart",
      padding: padding,
      data: {
            columns: [
                ['Registered Voters', .08, .16, .16, .18, .19, .13, .10, 0,],
                ['Absentee Voters 9/1-10/30', .05, .07, .07, .10, .21, .25, .22, .04,],
                ['Absentee Voters 10/31-11/7', .06, .11, .12, .16, .21, .16, .11, .08,]
            ],
        type: 'bar'
        },
        // legend: {
        //     show: false
        // },
            color: {
              pattern: ['#333','#865f67',"#C1ACB1"]
            },
        axis: {
              rotated: true,
              y: {
                    min: 0,
                    padding: {bottom: 0},
                    tick: {
                     count: 4,
                     format: d3.format('%')
                    }
                },
            x: {
                type: 'category',
                categories: ['18-24','25-34','35-44','45-54','55-64','65-74','75+','No age available']
            }
        }
});

}

chartAge();

//when
function chartDate(){

var  padding = {
        top: 20,
        right: 60,
        bottom: 20,
        left: 60,
    };

var chartPop = c3.generate({
      bindto: "#dateChart",
      padding: padding,
      data: {
            columns: [
                ['Ballots Accepted', 1425, 19693, 35324, 45298, 98057, 124844, 206871]
            ],
        type: 'line'
        },
        // legend: {
        //     show: false
        // },
            color: {
              pattern: ['#865f67']
            },
        axis: {
              // rotated: true,
              y: {
                    min: 0,
                    padding: {bottom: 0},
                    tick: {
                     count: 4,
                     format: d3.format(',.0f')
                    }
                },
            x: {
                type: 'category',
                categories: ['Sep. 1-25','Sep 26-30','Oct. 1-8','Oct. 9-15', 'Oct 16-24', 'Oct 25-31', 'Nov 1-7']
            }
        }
});

}

chartDate();

//lean
function chartCompare(){

var  padding = {
        top: 20,
        right: 60,
        bottom: 20,
        left: 60,
    };

var chartPop = c3.generate({
      bindto: "#compareChart",
      padding: padding,
      data: {
            x: 'x',
            columns: [
                ['x',1902,1903,1906,1908,1919,1920,1930,1932,1934,1936,1938,1940,1941,1942,1944,1945,1946,1947,1948,1949,1950,1951,1952,1953,1954,1955,1956,1957,1958,1959,1960,1961,1962,1963,1964,1965,1966,1967,1968,1969,1970,1971,1972,1973,1974,1975,1976,1977,1978,1979,1980,1981,1982,1983,1984,1985,1986,1987,1988,1989,1990,1991,1992,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2016],
                ['Voter Registrations', 2,1,3,1,1,1,1,1,1,2,1,1,2,2,10,2,14,4,39,2,21,16,119,11,32,27,198,18,111,43,309,37,155,69,372,77,299,79,594,89,321,198,802,492,2427,842,2050,368,1655,348,2044,274,1466,367,2952,477,1939,789,5429,3172,2952,1114,3849,1265,3482,1316,4368,1589,5019,1799,5678,2035,5616,1754,8971,2031,7040,3163,9616,2370,7377,3463,14506,5761,16824,13963,25313]
            ],
            type: 'line'
        },
        // legend: {
        //     show: false
        // },
            color: {
              pattern: ['#865f67']
            },
        axis: {
              y: {
                    min: 0,
                    padding: {bottom: 0},
                    tick: {
                     count: 4,
                     format: d3.format(',.0f')
                    }
                },
            x: {
                tick: {
                values: [1902, 1925, 1950, 1975, 2000, 2016],
                count: 6,
                multiline: false
                }
            }
        }
});

}

chartCompare();


});
});
</script>

</html>