<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Minnesota Legislature District Analysis</title>
  <meta name="description" content="Minnesota Legislature District Analysis">
  <meta name="author" content="Frey Hargarten - StarTribune">

  <link rel="stylesheet" href="../_common_resources/styles/startribune_dataviz_styles.css" />
  
  <style>

    body { font-family:"Benton Sans"; }
    #infobox { font-family:"Poynter Serif RE"; font-weight:900;  font-size:1.7em; }
    #infobox div { display:inline-block; width:31.5%; text-align:center; }
    #wrapper { width:100%; margin-right:auto; margin-left:auto; }
    #districtSelect { width:100%; text-align:center; }

    .t1 { fill:#6c7f8c !important; background-color:#6c7f8c; }
    .t2 { fill:#404b52 !important; background-color:#404b52; }
    .t3 { fill:#22282c !important; background-color:#22282c; }
    .t4 { fill:#131719 !important; background-color:#131719; }

    h2 { font-family:"Poynter Serif RE"; font-weight:900; }
    .column { display:inline-block; width:49.5%; vertical-align:top; text-align:center; }

    .switch { font-family:"Benton Sans"; display:inline-block; width:32%; text-align:center; }

    .republican { color:#a50f15; fill:#a50f15 !important; pointer-events: all; font-weight:bold; }
    .r1 { background-color:#DF4E55; fill:#DF4E55 !important; color:white !important; pointer-events: all; font-weight:bold; }
    .r2 { background-color:#a50f15; fill:#a50f15 !important; color:white !important; pointer-events: all; font-weight:bold; }
    .r3 { background-color:#830007; fill:#830007 !important; color:white !important; pointer-events: all; font-weight:bold; }
    .r4 { background-color:#590004; fill:#590004 !important; color:white !important; pointer-events: all; font-weight:bold; }
    .mid { background-color:#ddd; fill:#ddd !important; color:white !important; pointer-events: all; font-weight:bold; }
    .democrat { color:#082659; fill:#082659 !important; pointer-events: all; font-weight:bold; }
    .d1 { background-color:#284C88; fill:#284C88 !important; color:white !important; pointer-events: all; font-weight:bold; }
    .d2 { background-color:#082659; fill:#082659 !important; color:white !important; pointer-events: all; font-weight:bold; }
    .d3 { background-color:#041A40; fill:#041A40 !important; color:white !important; pointer-events: all; font-weight:bold; }
    .d4 { background-color:#010E25; fill:#010E25 !important; color:white !important; pointer-events: all; font-weight:bold; }

    #yearSelect { font-family:"Popular"; font-weight:900;  font-size:1.5em; }
    .year { display:inline-block; width:24%; text-align:center; }
    .year:hover, .district:hover, .selectedYear, .switch:hover { background-color:#333 !important; cursor:pointer; color:#fff; }

    .legendContainer { text-align:center; width:100%; }
    span { display:inline-block; }

    #filter input, #filter input:focus { width:100% !important; }

    .tableHead { display:inline-block; padding:10px; border-bottom:1px solid #ddd; width:18%; font-weight:900; font-family:"Poynter Serif RE"; }
    .tableCell { display:inline-block; padding:10px; border-bottom:1px solid #ddd; width:18%; font-family:"Benton Sans"; }
    .partyBar { width:50px !important; border-bottom:none !important; }
    .tableBreak { clear:both; display:block; }
    .table { text-align:center; }

    #mapSwitch { display:none; }

    .metro { float:right; }
    .mn { float:left; }

    #chatterBox { height:150px; }

    #toggleTables { text-align:center; }
    #toggleTables:hover { cursor:pointer; }

    .zoom { text-align:center !important; float:none !important; }

    @media (max-width:750px) {
      .map { width:100%; float:none; text-align:center; }
    }
  </style> 
</head>

<body>
  <div id="wrapper">

<div id="analysis">
<div id="districtSelect">
<h2>Voter Turnout by Precinct</h2>
<div id="gopColumn" class="column">
<div class="district republican selectedYear">02A</div>
<div class="district republican">10A</div>
<div class="district republican">10B</div>
<div class="district republican">11B</div>
<div class="district republican">12A</div>
<div class="district republican">14B</div>
<div class="district republican">17A</div>
<div class="district republican">17B</div>
<div class="district republican">21A</div>
<div class="district republican">24A</div>
</div>
<div id="dflColumn" class="column">
<div class="district republican">24B</div>
<div class="district republican">56B</div>
<div class="district republican">57B</div>
<div class="district democrat">36B</div>
<div class="district democrat">42A</div>
<div class="district democrat">42B</div>
<div class="district democrat">43A</div>
<div class="district democrat">48A</div>
<div class="district democrat">49A</div>
<div class="district democrat">50B</div>
</div>
</div>

<div class="breaker"></div>

<div id="infobox">
<div id="district">District</div>
<div id="year">2014</div>
<div id="race">House Races</div>
</div>

<div class="breaker"></div>

<div id="chatterBox" class="chatter">
<div id="candidateGOP">GOP candidate</div>
<div id="candidateDFL">DFL candidate</div>
<div id="chatter"></div>
</div>

<div id="maps">
<div id="map_turnoutMN" class="mn map y2014" data="turnout"><svg width="320" height="350" viewBox="0 0 500 550" preserveAspectRatio="xMidYMid"></svg></div>
<div id="map_turnoutMetro" class="metro map y2014" data="turnout"><svg width="320" height="350" viewBox="0 0 500 550" preserveAspectRatio="xMidYMid"></svg></div>

<div id="map_districtsMN" class="mn map y2014" data="districts"><svg width="320" height="350" viewBox="0 0 500 550" preserveAspectRatio="xMidYMid"></svg></div>
<div id="map_districtsMetro" class="metro map y2014" data="districts"><svg width="320" height="350" viewBox="0 0 500 550" preserveAspectRatio="xMidYMid"></svg></div>

<div id="map_censusMN" class="mn map y2014" data="census"><svg width="320" height="350" viewBox="0 0 500 550" preserveAspectRatio="xMidYMid"></svg></div>
<div id="map_censusMetro" class="metro map y2014" data="census"><svg width="320" height="350" viewBox="0 0 500 550" preserveAspectRatio="xMidYMid"></svg></div>
</div>

<div class="breaker"></div>

<div id="mapSwitch">
<div class="switch selectedYear" select="districts">Districts</div>
<div class="switch" select="census">Demographics</div>
<div class="switch" select="turnout">Turnout</div>
</div>

<div class="breaker"></div>

<div id="yearSelect">
<div class="year" data="y2008">2008</div>
<div class="year" data="y2010">2010</div>
<div class="year" data="y2012">2012</div>
<div class="year selectedYear" data="y2014">2014</div>
</div>

<div class="breaker"></div>

    <div class="legendContainer" data="turnout">
      <h5>Turnout</h5>
      <span class='legend'>
        <nav class='legend clearfix'>
          <span style='background:#fff;'>Less</span>
          <span class='t1'></span>
          <span class='t2'></span>
          <span class='t3'></span>
          <span class='t4'></span>
          <span style='background:#fff;'>More</span>
        </nav>
      </span>
    </div> 

    <div class="legendContainer" data="districts">
        <h5>Leaning</h5>
      <span class='legend'>
        <nav class='legend clearfix'>
          <span style='background:#fff;'>GOP</span>
          <span class='r4'></span>
          <span class='r3'></span>
          <span class='r2'></span>
          <span class='r1'></span>
          <span class='mid'></span>
          <span class='d1'></span>
          <span class='d2'></span>
          <span class='d3'></span>
          <span class='d4'></span>
          <span style='background:#fff;'>DFL</span>
        </nav>
      </span>
    </div> 

    <div class="legendContainer" data="census">
      <h5>Census</h5>
      <span class='legend'>
        <nav class='legend clearfix'>
          <span style='background:#fff;'>Less</span>
          <span class='t1'></span>
          <span class='t2'></span>
          <span class='t3'></span>
          <span class='t4'></span>
          <span style='background:#fff;'>More</span>
        </nav>
      </span>
    </div> 

<div class="breaker"></div>

<div id="charts">
<div id="chart_turnout" class="chart y2014" data="turnout"></div>
<div id="chart_districts" class="chart y2014" data="districts"></div>
<div id="chart_census" class="chart y2014" data="census"></div>
</div>

<div class="breaker"></div>

<div class="zoom">Reset View</div> 
</div>

<div id="toggleTables">TABLES</div>

<div id="tables">
<div id="filter"><input type="search" id="filter_box" placeholder="Search by keyword"></input></div>

<div id="table_turnout" class="table y2014" ="turnout"></div>
<div id="table_districts" class="table y2014" data="districts">
<div class='tableHead partyBar'>W</div><div class='tableHead'>Precinct</div><div class='tableHead'>County</div><div class='tableHead'>GOP Votes</div><div class='tableHead'>DFL Votes</div><div class='tableHead'>Turnout</div>
</div>
<div id="table_census" class="table y2014" data="census"></div>
</div>

  </div>
</body>



<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="../_common_resources/interfaces/d3.slider-master/d3.slider.js"></script>
<script src="../_common_resources/charts/nvd3-master/build/nv.d3.js"></script>
<script src="../_common_resources/charts/nvd3-master/src/utils.js"></script>
<script src="../_common_resources/charts/nvd3-master/src/tooltip.js"></script>
<script src="../_common_resources/charts/nvd3-master/src/models/legend.js"></script>
<script src="../_common_resources/charts/nvd3-master/src/models/axis.js"></script>
<script src="../_common_resources/charts/nvd3-master/test/stream_layers.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>

<script>
// $("#headerDiv").sticky({topSpacing:1});

</script>
<script>
//LIVE JSON MAGIC

//https://script.google.com/macros/s/AKfycbwG7mX6qPZaIhkwY2AJ2lU7kNarbm6OWIkWVfnmYZGYruIl40cu/exec?id=1qNwLNcSP2D8l8iTEemF9JC4lvpKp-UogxP4htDFwFA0&sheet=mn_house

d3.json("https://script.googleusercontent.com/macros/echo?user_content_key=63uCDLvwmjMmm55YXw67F6Dfm-CYq_m-NoS4PZtIBRQWzP2lCaYT2FhxtMusX59Tg0ATsn9s_xy5fyDFmlEIs6YX5T2moIGAOJmA1Yb3SEsKFZqtv3DaNYcMrmhZHmUMWojr9NvTBuBLhyHCd5hHaxCoMjMSmZWLp6XAShvjQj50JtCfh4yP7n1RnEoDeOH7XqmOXgX8RYIyMAhIAtjnF9UDzNXGLr6To3J9D8RNlRL0zgWNJzVDkWV4a9wKICNpTa8dfWNHYIymLIb4r3T2k2KsIDjhQ9px35iDyrfKhrpfHEAafmo-G5HS3VZadLm9&lib=MVcLnEUipyThKZcpmQKyqT_CoSfd4egCX", function(error, json) {

  d3.json("https://script.googleusercontent.com/a/macros/umn.edu/echo?user_content_key=hqcW4qxHJ--IlXiGmg2TOWSfCx-x3jdaF-E1FtnLluRTwYb-mW92zjhB3uakeLJMl1t5D7v1m0VYsV2yMvtW2639oqAGmEM2OJmA1Yb3SEsKFZqtv3DaNYcMrmhZHmUMi80zadyHLKASbbMAF6orU02DLGwV8tFzI-mtKRf-8plGOUy-lJCxpF2DQLccfmsBGWAyiujVfWxmelbCou2EhfNg1xV69xW9102aPo2dzOHFFUreli0hhOYpmBjx3ILLKOBPTBeFtzP1qPyR5eY853gQhsRdwb-KjjPLOhaSDCwmp7sOrB5lxGfraMZZq27VJ7ytWHyrXgE&lib=MVcLnEUipyThKZcpmQKyqT_CoSfd4egCX", function(error, json2) {

      d3.json("https://script.googleusercontent.com/a/macros/umn.edu/echo?user_content_key=J7gq0Mug2sgTNcGnn_rqd5m16ku4tlAetdD1wcXteOWwheCFeeZKh-r-H3dzmLZrbaC70jLP1Z_AtWMypGso--y7oZ4tocfLOJmA1Yb3SEsKFZqtv3DaNYcMrmhZHmUMi80zadyHLKASbbMAF6orU02DLGwV8tFzI-mtKRf-8plGOUy-lJCxpF2DQLccfmsBGWAyiujVfWxmelbCou2EhfNg1xV69xW9102aPo2dzOHFFUreli0hhOYpmBjx3ILLKOBPTBeFtzP1qPyR5eY853gQhsRdwb-KjjPLOhaSDCwmp7sOrB5lxIogQQuwV6UDjaqsI7Q_MTc&lib=MVcLnEUipyThKZcpmQKyqT_CoSfd4egCX", function(error, json3) {


var data = json;
var dataChatter = json2.mnleg_chatter;
var dataResults = json3.mn_house;

//SEARCH
$( document ).ready(function() {
     $('#filter_box').keyup(function(i){
        $('.card').hide();
        var txt = $('#filter_box').val();
        $('.card').each(function(){
           if($(this).text().toUpperCase().indexOf(txt.toUpperCase()) != -1){
               $(this).show();
           }
        });
    });
  });

//SELECTIONS
$("#tables").hide();

$("#toggleTables").click(function() {
  $("#tables").slideToggle( "slow", function() {
  });
  $("#analysis").slideToggle( "slow", function() {
  });
});

$(".year").click(function() {
  $(".year").removeClass("selectedYear");
  $(this).addClass("selectedYear");
  $(".table, .chart, .map").hide();
  $("." + $(this).attr("data")).show();
});

$("[data='census']").hide();
$("[data='turnout']").hide();

$(".switch").click(function() {
  $(".switch").removeClass("selectedYear");
  $(this).addClass("selectedYear");
  $("[data='census']").hide();
  $("[data='turnout']").hide();
  $("[data='districts']").hide();
  $("[data='" + $(this).attr("select") + "']").show();
});

console.log(dataChatter);

$(".district").click(function() {
  $(".district").removeClass("selectedYear");
  $(this).addClass("selectedYear");

  for (var i=0; i < dataChatter.length; i++){
      if ($(this).text() == dataChatter[i].district) { 
        $("#chatter").html(dataChatter[i].district); 
        $("#candidateGOP").html(dataChatter[i].candidateGOP); 
        $("#candidateDFL").html(dataChatter[i].candidateDFL);
      }
  }

  jQuery.fn.d3Click = function () {
  this.each(function (i, e) {
    var evt = document.createEvent("MouseEvents");
    evt.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);

    e.dispatchEvent(evt);
  });
};

jQuery.fn.d3Down = function () {
  this.each(function (i, e) {
    var evt = document.createEvent("MouseEvents");
    evt.initMouseEvent("mousedown", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);

    e.dispatchEvent(evt);
  });
};

jQuery.fn.d3Up = function () {
  this.each(function (i, e) {
    var evt = document.createEvent("MouseEvents");
    evt.initMouseEvent("mouseup", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);

    e.dispatchEvent(evt);
  });
};
    
    $("#district").html("District " + $(this).text());

    redrawChart(chart,"#chart",$(this).parent().parent().attr("data"),data,$(this).text(),0);

    $("[id='" + $(this).text().replace(new RegExp(" ", "g"),"-") + "']").d3Down();
    $("[id='" + $(this).text().replace(new RegExp(" ", "g"),"-") + "']").d3Up();
    $("[id='" + $(this).text().replace(new RegExp(" ", "g"),"-") + "']").d3Click();
});

//TABLECALYPSE
function tableBuild(container,race,data,state,county,index){

d3.select(container).selectAll(".card")
.data(data).enter().append("div")
.attr("class","card")
.html(function (d){ 
  if (race = "governor"){
    if (d.MNGOVR > d.MNGOVDFL) { var swatch = "republican"; var party = "GOP"; }
    else if (d.MNGOVR < d.MNGOVDFL) { var swatch = "democrat"; var party = "DFL"; }
    else { var swatch = "democrat"; var party = "IP"; }
    return "<div class='tableBreak'></div><div class='tableCell partyBar " + swatch + "'>" + party + "</div><div class='tableCell precinct'>" + d.PCTNAME + "</div><div class='tableCell county'>" + d.COUNTYNAME + "</div><div class='tableCell votes'>" + d3.format(',')(d.MNGOVR) + "</div><div class='tableCell votes'>" + d3.format(',')(d.MNGOVDFL) + "</div><div class='tableCell pct'>" + d3.format('%')(d.TOTVOTING / d.REG7AM) + "</div><div class='tableBreak'></div>";
  }
});

}

//MAPAGGEDON
function mapColor(d, race, dataCompare){
  if (d == "Minnesota") { var where = "Minnesota"; }
  else { var where = d; }

  if (race == "turnout"){
  for (var i = 0; i < dataCompare.length; i++) {
  if (dataCompare[i].PCTNAME == where){
    if ((dataCompare[i].TOTVOTING / dataCompare[i].REG7AM) >= .90) { return "t4"; }
    if ((dataCompare[i].TOTVOTING / dataCompare[i].REG7AM) >= .70) { return "t3"; }
    if ((dataCompare[i].TOTVOTING / dataCompare[i].REG7AM) >= .50) { return "t2"; }
    if ((dataCompare[i].TOTVOTING / dataCompare[i].REG7AM) >= .30) { return "t1"; }
    }
  }
}
  if (race == "mnleg"){
    var gopCount;
    var dflCount;
  for (var i = 0; i < dataCompare.length; i++) {
  if (dataCompare[i].county_id == where){
    if (dataCompare[i].party_id == "DFL") { dflCount = dataCompare[i].vote_pct; }
    if (dataCompare[i].party_id == "R") { gopCount = dataCompare[i].vote_pct; }
    }
  }

    if (gopCount > dflCount) { return "republican"; }
    else if (gopCount < dflCount) { return "democrat"; }
    else { return "mid"; }
}
 
}

function mapTips(d, subject, dataCompare){
  if (d == "Minnesota") { var where = "Minnesota"; }
  else { var where = d.properties.DISTRICT; }

  if (subject == "turnout"){
    for (var i = 0; i < dataCompare.length; i++){
  if (dataCompare[i].PCTNAME == where){
    var color = "t1";
    return "<span class='swatch " + color + "'></span><span class='countyName'>" + where + "</span><div class='turnout'>" + d3.format('%')(dataCompare[i].TOTVOTING / dataCompare[i].REG7AM) + " turnout</div>";       }
     }
    }

  if (subject == "mnleg"){
    // for (var i = 0; i < dataCompare.length; i++){
    // if (dataCompare[i].MNLEGDFL > dataCompare[i].MNLEGR) { var color = "democrat"; }
    // else if (dataCompare[i].MNLEGDFL < dataCompare[i].MNLEGR) { var color = "republican"; }
    // else { var color = "other"; }
  // if (dataCompare[i].county_id == where){
    return "<span class='swatch'></span><span class='countyName'>" + where + "</span>";       }
     // }
    // }
}

function mapBuild(container, boxContainer, chartContainer, shape, race, geo, dataCompare, index) {

var width = 350,
    height = 400,
    centered;

if (geo=="us") { var projection = d3.geo.albersUsa().scale(700).translate([330, 200]); }
else if (geo=="mn") { var projection = d3.geo.albersUsa().scale(5037).translate([50, 970]); }
else if (geo=="metro") { var projection = d3.geo.mercator().scale([16800]).center([-92.263184,44.863656]); }

var path = d3.geo.path()
    .projection(projection);

var svg = d3.select(container + " svg")
    .attr("width", width)
    .attr("height", height);

svg.append("rect")
    .attr("class", "background")
    .attr("width", width)
    .attr("height", height);

var g = svg.append("g");

d3.json("shapefiles/" + shape, function(error, us) {

  g.append("g")
      .attr("class", "states")
    .selectAll("path")
      .data(us.features)
    .enter().append("path")
      .attr("d", path)
      .on("click", clicked)
      .attr("id", function(d) { var str = d.properties.DISTRICT; return str.replace(new RegExp(" ", "g"),"-"); })
      .attr("precinctName", function(d){ return d.properties.DISTRICT })
      .attr("class", function(d){
         return mapColor(d.properties.DISTRICT, race, dataCompare);
        })
       .on("mousedown", function(d, i){   
          $('.precinct').removeClass("pSelect");
          $('.card').hide();
        var txt = d.properties.PCTNAME;
        $('.card').each(function(){
           if($(this).text().toUpperCase().indexOf(txt.toUpperCase()) != -1){
               $(this).show();
           }
        });
          $("#precinctName").html(d.properties.DISTRICT + ", " + d.properties.DISTRICT + " County");
          redrawChart(chart,"#chart",race,dataCompare,d.properties.PCTNAME,0);
       })
      .style("stroke-width", "0")
      // .style("stroke", "#fff")
      .call(d3.helper.tooltip(function(d, i){
        return mapTips(d, race, dataCompare);
      }));

  g.append("path")
      //.datum(topojson.mesh(us, us.features, function(a, b) { return a !== b; }))
      .attr("id", "state-borders")
      .attr("d", path);
});

var zoom = d3.behavior.zoom()
    .on("zoom",function() {
        g.attr("transform","translate("+ 
            d3.event.translate.join(",")+")scale("+d3.event.scale+")");
        g.selectAll("circle")
            .attr("d", path.projection(projection));
        g.selectAll("path")  
            .attr("d", path.projection(projection)); 

  });

$(".zoom, .myButton2").click(function() {
  clicked2();
  $('.precinct').removeClass("pSelect");
  $("#precinctName").html("Minnesota");
  $(".card").show();
  redrawChart(chart,"#chart",race,dataCompare,"Minnesota",0);
});

function clicked(d) {
  var x, y, k;

  if (d && centered !== d) {
    var centroid = path.centroid(d);
    x = centroid[0];
    y = centroid[1];
    k = 4;
    centered = d;
  } else {
    x = width / 2;
    y = height / 2;
    k = 10;
    centered = null;
  }

  g.selectAll("path")
      .classed("faded", true)
      .classed("active", centered && function(d) { return d === centered; });

  g.transition()
      .duration(750)
      .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
      .style("stroke-width", 1.5 / k + "px");
}

function clicked2(d) {
  var x, y, k;

  if (d && centered !== d) {
    var centroid = path.centroid(d);
    x = centroid[0];
    y = centroid[1];
    k = 1;
    centered = d;
  } else {
    x = width / 2;
    y = height / 2;
    k = 1;
    centered = null;
  }

  g.selectAll("path")
      .classed("faded", false)
      .classed("active", centered && function(d) { return d === centered; });

  g.transition()
      .duration(750)
      .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
      .style("stroke-width", 1.5 / k + "px");
}

d3.helper = {};

d3.helper.tooltip = function(accessor){
    return function(selection){
        var tooltipDiv;
        var bodyNode = d3.select('body').node();
        selection.on("mouseover", function(d, i){
            // Clean up lost tooltips
            d3.select('body').selectAll('div.tooltip').remove();
            // Append tooltip
            tooltipDiv = d3.select('body').append('div').attr('class', 'tooltip');
            var absoluteMousePos = d3.mouse(bodyNode);
            tooltipDiv.style('left', (absoluteMousePos[0] + 10)+'px')
                .style('top', (absoluteMousePos[1] - 15)+'px')
                .style('position', 'absolute') 
                .style('z-index', 1001);
            // Add text using the accessor function
            var tooltipText = accessor(d, i) || '';
            // Crop text arbitrarily
            //tooltipDiv.style('width', function(d, i){return (tooltipText.length > 80) ? '300px' : null;})
            //    .html(tooltipText);
        })
        .on('mousemove', function(d, i) {
            // Move tooltip
            var absoluteMousePos = d3.mouse(bodyNode);
            tooltipDiv.style('left', (absoluteMousePos[0] + 10)+'px')
                .style('top', (absoluteMousePos[1] - 15)+'px');
            var tooltipText = accessor(d, i) || '';
            tooltipDiv.html(tooltipText);
        })
        .on("mouseout", function(d, i){
            // Remove tooltip
            tooltipDiv.remove();
        });

    };
};

}

var chart = [];
var index = 0;
//CHARTAGGEDON
function chartBuild(container,subject,data,county,index){
  var colorArray = ['#a50f15','#082659','#777']; 
  var formatter = d3.format('%');

nv.addGraph(function() {
  chart[index] = nv.models.multiBarHorizontalChart()
      .x(function(d) { return d.label })
      .y(function(d) { return d.value })
      .margin({top: 30, right: 30, bottom: 20, left: 80})
      .showValues(true)
      .tooltips(true)
      .stacked(false)
      .showLegend(false)
      .color(colorArray)
      // .width($(container).width()).height($(container).height())
      .showControls(false);

  chart[index].forceY([0,1]);

   chart[index].yAxis
      .tickFormat(formatter);

  d3.select('#chart svg')
      .datum(chartData("governor",data,"Minnesota"))
      .transition().duration(500)
      .call(chart[index]);

  nv.utils.windowResize(chart[index].update);

  return chart[index];
});

// }

function redrawChart(chart,container,subject,data,county,index){
  var colorArray = ['#a50f15','#082659','#777']; 
  var formatter = d3.format('%');

    d3.select(container + ' svg').datum(chartData(subject,data,county)).transition().duration(300).call(chart[index].color(colorArray));
    // chart[index].yAxistickFormat(formatter);
    nv.utils.windowResize(chart[index].update);
}

function chartData(subject,data,county) {
if (subject == "ussenate"){
  for (var i=0; i < data.length; i++){
    if (data[i].PCTNAME == county) { 
      return [{
        "key": "Vote %",
        "values": [
          { 
            "label" : "GOP" ,
            "value" : data[i].USSENR / data[i].USSENTOTAL
          } , 
          { 
            "label" : "DFL" ,
            "value" : data[i].USSENDFL / data[i].USSENTOTAL
          } , 
          { 
            "label" : "Other" ,
            "value" : (data[i].USSENIP + data[i].USSENLIB + data[i].USSENWI) / data[i].USSENTOTAL
          } , 
          { 
            "label" : "Turnout" ,
            "value" : data[i].TOTVOTING / data[i].REG7AM
          } 
        ]
      }]
    }
  }
}

if (subject == "uscongress"){
  for (var i=0; i < data.length; i++){
    if (data[i].PCTNAME == county) { 
      return [{
        "key": "GOP Vote %",
        "values": [
          { 
            "label" : "GOP" ,
            "value" : data[i].USREPR / data[i].USREPTOTAL
          } 
        ]
      },{
        "key": "DFL Vote %",
        "values": [
          { 
            "label" : "DFL" ,
            "value" : data[i].USREPDFL / data[i].USREPTOTAL
          } 
        ]
      },{
        "key": "Other Vote %",
        "values": [
          { 
            "label" : "Other" ,
            "value" : (data[i].USREPIP + data[i].USREPR + data[i].USREPWI) / data[i].USREPTOTAL
          }
        ]
      },{
        "key": "Turnout %",
        "values": [
          { 
            "label" : "Turnout" ,
            "value" : data[i].TOTVOTING / data[i].REG7AM
          }  
        ]
      }]
    }
  }
}

if (subject == "mnleg"){
  for (var i=0; i < data.length; i++){
    if (data[i].PCTNAME == county) { 
      return [{
        "key": "GOP Vote %",
        "values": [
          { 
            "label" : "GOP" ,
            "value" : data[i].MNLEGR / data[i].MNLEGTOTAL
          }
        ]
      },{
        "key": "DFL Vote %",
        "values": [ 
          { 
            "label" : "DFL" ,
            "value" : data[i].MNLEGDFL / data[i].MNLEGTOTAL
          } 
        ]
      },{
        "key": "Other Vote %",
        "values": [
          { 
            "label" : "Other" ,
            "value" : (data[i].MNLEGIP + data[i].MNLEGWI) / data[i].MNLEGTOTAL
          } 
        ]
      },{
        "key": "Turnout %",
        "values": [
          { 
            "label" : "Turnout" ,
            "value" : data[i].TOTVOTING / data[i].REG7AM
          } 
        ]
      }]
    }
  }
}

if (subject == "governor"){
  for (var i=0; i < data.length; i++){
    if (data[i].PCTNAME == county) { 
      return [{
        "key": "GOP Vote %",
        "values": [
          { 
            "label" : "GOP" ,
            "value" : data[i].MNGOVR / data[i].MNGOVTOTAL
          } 
        ]
      },{
        "key": "DFL Vote %",
        "values": [
          { 
            "label" : "DFL" ,
            "value" : data[i].MNGOVDFL / data[i].MNGOVTOTAL
          }
        ]
      },{
        "key": "Other Vote %",
        "values": [ 
          { 
            "label" : "Other" ,
            "value" : (data[i].MNGOVIP + data[i].MNGOVLIB + data[i].MNGOVGLC + data[i].MNGOVWI) / data[i].MNGOVTOTAL
          }
        ]
      },{
        "key": "Turnout %",
        "values": [
          { 
            "label" : "Turnout" ,
            "value" : data[i].TOTVOTING / data[i].REG7AM
          } 
        ]
      }]
    }
  }
}

}

  tableBuild("#table_districts","governor",data,"Minnesota","All",0)
  mapBuild("#map_districtsMetro", "#district", "#chart", "mnleg_metro.json", "mnleg", "metro", dataResults, 0);
  mapBuild("#map_districtsMN", "#district", "#chart", "mnleg.json", "mnleg", "mn", dataResults, 0);

    });
  });
});
</script>


</html>