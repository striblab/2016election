<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>How the GOP took the Minnesota House of Representatives</title>
  <meta name="description" content="How the GOP took the Minnesota House of Representatives">
  <meta name="author" content="Frey Hargarten - StarTribune">

  <link href="../_common_resources/charts/c3-master/c3.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="../_common_resources/styles/startribune_dataviz_styles.css" />
  
<style>
/*BASE LAYOUT*/
    body, p { font-family:"Benton Sans",Helvetica,Arial,sans-serif; }
    #wrapper { width:520px; margin-right:auto; margin-left:auto; }
    .leftSide { width:63%; float:right; }
    .rightSide { width:30%; float:left; }
    .right { float:left; width:48%; }
    .left { float:right; width:48%; }
    .labelTop { display:inline-block; padding-top:5px; padding-bottom:5px; font-weight:normal; }
    #changeView { width:100%; margin-left:auto; margin-right:auto; display:none; }
    .leftHalf { float:left; color:inherit !important; background-color:inherit !important; }
    .rightHalf { float:right; color:#000 !important; }
    .breaker { display:block !important; clear:both !important; width:100% !important; }
    .layer { height:460px; }
    #viewSwitch { display:none; }
    #viewSwitch .step { border:0 !important; }
    path:hover { cursor:default !important; }
    .chart { display:none; }

/*POWERBAR*/
    .powerBar { text-align:center; vertical-align:top; }
    .rows { width:47px;  display:inline-block; vertical-align:bottom; }
    .rowMid { width:85%; display:inline-block; }
    #dBar { margin-bottom:21px; padding:1px; }
    #rBar {  margin-bottom:21px; padding:1px; }
    #dlBar { width:0; margin-bottom:21px; }
    #rlBar { width:0; margin-bottom:21px; }
    #dwBar { width:0; margin-bottom:21px; }
    #rwBar { width:0; margin-bottom:21px; }
    #tBar { width:0; margin-bottom:21px; }
    .bar { height:20px; width:100%; vertical-align:top; text-align:center; }
    .half { display:inline-block; height:20px;  }
    .bigNum { font-size:2.5em !important; }

/*CHARTS*/
    #chart { width:100%; height:430px; }
    .powerline { stroke-dasharray:5,5; stroke:#333; }
    .chartTitle { margin-top:0 !important; padding-left:5px;font-weight:normal; font-size:1.3em; }
    #chart .c3-line { stroke-width:5px !important; }

/*LEGENDS*/
    #legends { display:block; height:auto; margin-right:auto; margin-left:auto; clear:both; }
    #legendMain { text-align:center; display:none; }
    #legendMap { text-align:center; }
    .legends { display:inline-block; width:30%; text-align:center; }

/*MAPS*/
    #mapBox { text-align:center; }
    .map { display:inline-block; width:48%; }
    .districtName { font-weight:900; font-size:1.2em; }

/*SWATCHES*/
    .republican { background-color:#8C1B17; fill:#8C1B17 !important; pointer-events: all; font-weight:bold; color:#fff; }
    .rlikely { background-color:#A5484D; fill:#A5484D !important; pointer-events: all; font-weight:bold; }
    .rlean { background-color:#f7816E; fill:#f7816E !important; pointer-events: all; font-weight:bold; }
    .r1 { background-color:#C68985; fill:#C68985 !important; color:white !important; pointer-events: all; font-weight:bold; }
    .r2 { background-color:#A5484D; fill:#A5484D !important; color:white !important; pointer-events: all; font-weight:bold; }
    .r3 { background-color:#A52129; fill:#A52129 !important; color:white !important; pointer-events: all; font-weight:bold; }
    .r4 { background-color:#8C1B17; fill:#8C1B17 !important; color:white !important; pointer-events: all; font-weight:bold; }
    .r0 { background-color:#8C1B17; fill:#8C1B17 !important; color:white !important; pointer-events: all; font-weight:bold; }
    .gray3 { color:white !important; pointer-events: all; font-weight:bold; }
    .mid { background-color:#aaa; fill:#aaa !important; color:white !important; pointer-events: all; font-weight:bold; }
    .democrat { background-color:#3F88C5; fill:#3F88C5 !important; pointer-events: all; font-weight:bold; color:#fff;  }
    .dlikely { background-color:#5ca5c3; fill:#5ca5c3 !important; pointer-events: all; font-weight:bold; }
    .dlean { background-color:#72A9D6; fill:#72A9D6 !important; pointer-events: all; font-weight:bold; }
    .d1 { background-color:#ABCEE8; fill:#ABCEE8 !important; color:white !important; pointer-events: all; font-weight:bold; }
    .d2 { background-color:#5ca5c3; fill:#5ca5c3 !important; color:white !important; pointer-events: all; font-weight:bold; }
    .d3 { background-color:#4f97c4; fill:#4f97c4 !important; color:white !important; pointer-events: all; font-weight:bold; }
    .d4 { background-color:#3f88c5; fill:#3f88c5 !important; color:white !important; pointer-events: all; font-weight:bold; }
    .d0 { background-color:#3F88C5; fill:#3F88C5 !important; color:white !important; pointer-events: all; font-weight:bold; }
    .text { fill:#ffffff !important; font-size:1em; }
    rect:hover, text:hover { background-color:#333 !important; cursor:pointer; opacity:.5; }

/*SEATS*/
    .box { display:inline-block; width:29px !important; height:15px; text-align:center; vertical-align:middle; margin:2px; font-size:.8em; padding:0 !important; }
    #chamberPower { text-align:center; }
    .boxes { clear:both; margin:4px; }
    .chamberLabel { width:100%; display:block !important; text-align:left !important; padding-bottom:7px; font-size:1.3em; clear:both; height:39px; }
    .describe { vertical-align:middle; padding-top:7px; padding-left:7px; }
    .district { display:inline-block; }
    #inPlay { /*padding:7px; margin:5px; */}
    .district:hover { cursor:pointer; background-color:#333; }
    .fadeBox { opacity:.1; -webkit-transition: width 2s; transition: opacity 1s ease-in-out; }
    .thisBox { opacity:1 !important; border:5px solid #333; -webkit-transition: width 2s; transition: opacity 1s ease-in-out; }
    #clickDistrict { color:#ccc; padding:10px; text-align:center; }
    .count { font-size:1em;  letter-spacing:1.1px; font-weight:bold; font-family:"Benton Sans",sans-serif;  width:40px; height:40px;  float:left; text-align:center; padding-top:7px; background:none !important; background-color:none !important; fill:none !important;  color:#333 !important; margin-right:0px !important; }


/*MOBILE BREAKPOINTS*/
    @media (max-width:500px) {
      #wrapper { width:100%; margin-right:auto; margin-left:auto; }
      .metro { display:none; }
    }
</style> 
</head>

<body>
<div id="wrapper">

<div class="chart" id="history">
<div class="chartTitle">Minnesota House balance of power 2002-2016</div>
<div id="chart"></div>
</div>

<div class="breaker"></div>

<div class="chart" id="obama">
<div class="chartTitle">2008 Minnesota House election results</div>
<div class="powerbar">
      <div class="bar"><div class="half tips democrat" style="text-align:left;width:65%">87</div><div class="half tips d2"></div><div class="half tips d1"></div><div class="half tips mid"></div><div class="half tips r1"></div><div class="half tips republican"></div><div class="half tips r0" style="text-align:right;width:34%">47</div></div>
</div>
<div id="mapState2008" class="map"><svg width="320" height="350" viewBox="0 0 500 550" preserveAspectRatio="xMidYMid"></svg></div>
<div id="mapMetro2008" class="map metro"><svg width="320" height="350" viewBox="0 0 500 550" preserveAspectRatio="xMidYMid"></svg></div>
</div>

<div class="breaker"></div>

<div class="chart" id="relection">
<div class="chartTitle">2012 Minnesota House election results</div>
<div class="powerbar">
      <div class="bar"><div class="half tips democrat" style="text-align:left;width:54%">73</div><div class="half tips d2"></div><div class="half tips d1"></div><div class="half tips mid"></div><div class="half tips r1"></div><div class="half tips republican"></div><div class="half tips r0" style="text-align:right;width:45%">61</div></div>
</div>
<div id="mapState2012" class="map"><svg width="320" height="350" viewBox="0 0 500 550" preserveAspectRatio="xMidYMid"></svg></div>
<div id="mapMetro2012" class="map metro"><svg width="320" height="350" viewBox="0 0 500 550" preserveAspectRatio="xMidYMid"></svg></div>
</div>

<div class="breaker"></div>

<div class="chart" id="trump">
<div class="chartTitle">2016 Minnesota House election results</div>
<div class="powerbar">
      <div class="bar"><div class="half tips democrat" style="text-align:left;width:43%">57</div><div class="half tips d2"></div><div class="half tips d1"></div><div class="half tips mid"></div><div class="half tips r1"></div><div class="half tips republican"></div><div class="half tips r0" style="text-align:right;width:56%">76</div></div>
</div>
<div id="mapState" class="map"><svg width="320" height="350" viewBox="0 0 500 550" preserveAspectRatio="xMidYMid"></svg></div>
<div id="mapMetro" class="map metro"><svg width="320" height="350" viewBox="0 0 500 550" preserveAspectRatio="xMidYMid"></svg></div>
</div>

</div>
<!-- end wrapper -->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
<script src="../_common_resources/js/d3-master/d3.min.js" charset="utf-8"></script>
<script src="../_common_resources/charts/c3-master/c3.min.js"></script>
<script>
d3.csv("./data/mnhouse2016.csv", function(d) {
  return {
    district: d.district,
    gop: +d.gop,
    dfl: +d.dfl   
  };
}, function(error, rows1) {

d3.csv("./data/mnhouse2012.csv", function(d) {
  return {
    district: d.district,
    gop: +d.gop,
    dfl: +d.dfl      
  };
}, function(error, rows2) {

d3.csv("./data/mnhouse2008.csv", function(d) {
  return {
    district: d.district,
    gop: +d.gop,
    dfl: +d.dfl      
  };
}, function(error, rows3) {


var data2008 = rows3;
var data2012 = rows2;
var data2016 = rows1;

$.urlParam = function(name){
  var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
  if (results != null) { return results[1] || 0; }
  else { return null; }
}

var selected = $.urlParam('chart');

if (selected != null){
$(".chart").hide();
$("#" + selected).show();
} else { $(".chart").show(); }

function chartBuilder(){
var  padding = {
        top: 20,
        right: 40,
        bottom: 20,
        left: 60,
    };

var chart = c3.generate({
        bindto: '#chart',
        padding: padding,
    data: {
        x: 'x',
        columns: [
            ['x',2002,2004,2006,2008,2010,2012,2014,2016],
            ['DFL Seats',52,66,85,87,62,73,62,57],
            ['GOP Seats',81,68,49,47,72,61,72,76]
        ],
        type: 'line'
    },
    // legend: {
    //     show: false
    // },
    color:  {  pattern: ["#3F88C5","#A52129"] },
    axis: {
      y: {
            min: 0,
            padding: {bottom: 0},
            tick: {
             values: [0,67,96],
             count: 3,
             format: d3.format('.0f')
            }
        },
        x: {
            tick: {
                values: ['2002', '2004', '2008', '2012', '2016'],
                count: 5,
                multiline: false
            },
            padding: {
            left: .7,
            right: .3
          }
          }
        },
    grid: {
        y: {
          lines: [
                {value: 67, text: '', position: 'start', class:'powerline'}
          ]

        },
        x: {
            lines: [
                {value: 2002, text: 'Midterm', position: 'start'},
                {value: 2004, text: 'Bush (R) Win', position: 'start'},
                {value: 2006, text: 'Midterm', position: 'start'},
                {value: 2008, text: 'Obama (D) Win', position: 'start'},
                {value: 2010, text: 'Midterm', position: 'start'},
                {value: 2012, text: 'Obama (D) Win', position: 'start'},
                {value: 2014, text: 'Midterm', position: 'start'},
                {value: 2016, text: 'Trump (R) Win', position: 'start'},
            ]
        }
    }
});
}

function mapColor(d, race, dataCompare){
   if (race != "redistrict"){ 
    for (var i=0; i < dataCompare.length; i++){
        if (d.properties.DISTRICT == dataCompare[i].district){
            if (dataCompare[i].gop > dataCompare[i].dfl) { return "r3"; }
            else if (dataCompare[i].gop < dataCompare[i].dfl) { return "d3"; }
        }
    } 
   }
   else { 
    for (var i=0; i < dataCompare.length; i++){
        if (d.properties.NAME == dataCompare[i].district){
            if (dataCompare[i].gop > dataCompare[i].dfl) { return "r3"; }
            else if (dataCompare[i].gop < dataCompare[i].dfl) { return "d3"; }
        }
    }
   }
}

function mapTips(d, subject, dataCompare){
   if (subject != "redistrict"){ 
    for (var i=0; i < dataCompare.length; i++){
        if (d.properties.DISTRICT == dataCompare[i].district){
            if (dataCompare[i].gop > dataCompare[i].dfl) { return "<div class='districtName'>District " + d.properties.DISTRICT + "</div><div class='republican'>" + d3.format(".1f")(dataCompare[i].gop) + "% GOP</div><div class='democrat'>" + d3.format(".1f")(dataCompare[i].dfl) + "% DFL</div>"; }
            else if (dataCompare[i].gop < dataCompare[i].dfl) { return "<div class='districtName'>District " + d.properties.DISTRICT + "</div><div class='democrat'>" + d3.format(".1f")(dataCompare[i].dfl) + "% DFL</div><div class='republican'>" + d3.format(".1f")(dataCompare[i].gop) + "% GOP</div>"; }
        }
    } 
    return "<div class='districtName'>District " + d.properties.DISTRICT + "</div>"
   }
   else { 
    for (var i=0; i < dataCompare.length; i++){
        if (d.properties.NAME == dataCompare[i].district){
            if (dataCompare[i].gop > dataCompare[i].dfl) { return "<div class='districtName'>District " + d.properties.NAME + "</div><div class='republican'>" + d3.format(".1f")(dataCompare[i].gop) + "% GOP</div><div class='democrat'>" + d3.format(".1f")(dataCompare[i].dfl) + "% DFL</div>"; }
            else if (dataCompare[i].gop < dataCompare[i].dfl) { return "<div class='districtName'>District " + d.properties.NAME + "</div><div class='democrat'>" + d3.format(".1f")(dataCompare[i].dfl) + "% DFL</div><div class='republican'>" + d3.format(".1f")(dataCompare[i].gop) + "% GOP</div>"; }
        }
    }
    return "<div class='districtName'>District " + d.properties.NAME + "</div>"
   }
       
}

function mapBuild(container, boxContainer, chartContainer, shape, race, geo, dataCompare, index) {

var width = 320,
    height = 400,
    centered;

if (geo=="us") { var projection = d3.geo.albersUsa().scale(700).translate([330, 200]); }
else if (geo=="mn") { var projection = d3.geo.albersUsa().scale(5037).translate([50, 970]); }
else if (geo=="metro") { var projection = d3.geo.mercator().scale([16800]).center([-92.384033,45.209134]); }

var path = d3.geo.path()
    .projection(projection);

var svg = d3.select(container + " svg")
    .attr("width", width)
    .attr("height", height);

svg.append("rect")
    .attr("class", "background")
    .attr("width", width)
    .attr("height", height);

var g = svg.append("g");

d3.json("shapefiles/" + shape, function(error, us) {

  g.append("g")
      .attr("class", "states")
    .selectAll("path")
      .data(us.features)
    .enter().append("path")
      .attr("d", path)
      // .on("click", clicked)
      .attr("id", function(d) { var str = geo + "_" + d.properties.DISTRICT; return str.replace(new RegExp(" ", "g"),"-"); })
      .attr("precinctName", function(d){ return d.properties.DISTRICT })
      .attr("class", function(d){
         return mapColor(d, race, dataCompare);
        })
      .style("stroke-width", "1px")
      .style("stroke", "#fff")
      .call(d3.helper.tooltip(function(d, i){
        return mapTips(d, race, dataCompare);
      }));

  g.append("path")
      //.datum(topojson.mesh(us, us.features, function(a, b) { return a !== b; }))
      .attr("id", "state-borders")
      .attr("d", path);

});

var zoom = d3.behavior.zoom()
    .on("zoom",function() {
        g.attr("transform","translate("+ 
            d3.event.translate.join(",")+")scale("+d3.event.scale+")");
        g.selectAll("circle")
            .attr("d", path.projection(projection));
        g.selectAll("path")  
            .attr("d", path.projection(projection)); 

  });

$(".zoom, .switch, #close, .mapSwitch").click(function() {
  clicked2();
  $("#filter input").val("");
  $(".district").removeClass("selected");
  $("#infobox").hide();
  d3.selectAll(".map rect").classed('faded', false); 
  d3.selectAll(".map rect").classed('active', false); 
  $(".rightSide").show();
});

$(".mapSwitch").click(function() {
  $("#filter input").val("");
});

function clicked(d) {
  var x, y, k;

  if (d && centered !== d) {
    var centroid = path.centroid(d);
    x = centroid[0];
    y = centroid[1];
    k = 6;
    centered = d;
  } else {
    x = width / 2;
    y = height / 2;
    k = 3;
    centered = null;
  }

  d3.selectAll("#mapMetro path, #mapState path")
      .classed("faded", false)
      .classed("active", false);

  g.selectAll("path")
      .classed("faded", true)
      .classed("active", centered && function (d) { return d === centered; });
}

function clicked2(d) {
  var x, y, k;

  if (d && centered !== d) {
    var centroid = path.centroid(d);
    x = centroid[0];
    y = centroid[1];
    k = 1;
    centered = d;
  } else {
    x = width / 2;
    y = height / 2;
    k = 1;
    centered = null;
  }

  g.selectAll("path")
      .classed("faded", false)
      .classed("active", centered && function (d) { return d === centered; });
}

}

d3.helper = {};

d3.helper.tooltip = function(accessor){
    return function(selection){
        var tooltipDiv;
        var bodyNode = d3.select('body').node();
        selection.on("mouseover", function(d, i){
            // Clean up lost tooltips
            d3.select('body').selectAll('div.tooltip').remove();
            // Append tooltip
            tooltipDiv = d3.select('body').append('div').attr('class', 'tooltip');
            var absoluteMousePos = d3.mouse(bodyNode);
            tooltipDiv.style('left', (absoluteMousePos[0] + 10)+'px')
                .style('top', (absoluteMousePos[1] - 15)+'px')
                .style('position', 'absolute') 
                .style('z-index', 1001);
            // Add text using the accessor function
            var tooltipText = accessor(d, i) || '';
            // Crop text arbitrarily
            //tooltipDiv.style('width', function(d, i){return (tooltipText.length > 80) ? '300px' : null;})
            //    .html(tooltipText);
        })
        .on('mousemove', function(d, i) {
            // Move tooltip
            var absoluteMousePos = d3.mouse(bodyNode);
            tooltipDiv.style('left', (absoluteMousePos[0] + 10)+'px')
                .style('top', (absoluteMousePos[1] - 15)+'px');
            var tooltipText = accessor(d, i) || '';
            tooltipDiv.html(tooltipText);
        })
        .on("mouseout", function(d, i){
            // Remove tooltip
            tooltipDiv.remove();
        });

    };
};

  chartBuilder();

  mapBuild("#mapMetro", "#infobox", "#chart", "mnleg_metro.json", "house", "metro", data2016, 0);
  mapBuild("#mapState", "#infobox", "#chart", "mnleg.json", "house", "mn", data2016, 0);

  mapBuild("#mapMetro2012", "#infobox", "#chart", "mnleg_metro.json", "house", "metro", data2012, 0);
  mapBuild("#mapState2012", "#infobox", "#chart", "mnleg.json", "house", "mn", data2012, 0);

  mapBuild("#mapMetro2008", "#infobox", "#chart", "mnleg2008_metro.json", "redistrict", "metro", data2008, 0);
  mapBuild("#mapState2008", "#infobox", "#chart", "mnleg2008.json", "redistrict", "mn", data2008, 0);

});
});
});
</script>
</body>
</html>