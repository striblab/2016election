<!doctype html>

<html lang="en">
<head>
    <meta charset='utf-8' />
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <title>Campaign Finance in Minnesota's 2016 Elections</title>
    <meta name="description" content="Campaign Finance in Minnesota's 2016 Elections">
    <meta name="author" content="Frey Hargarten - StarTribune">

    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.0/themes/base/jquery-ui.css">
    <link href="../_common_resources/charts/c3-master/c3.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="../_common_resources/styles/startribune_dataviz_styles.css" /> 

    <style>
        body { margin:0; padding:0; font-family:"Benton Sans",Helvetica,Arial,sans-serif; }
        #wrapper { width:960px; margin-right:auto; margin-left:auto; }

        #leftSide { width:48%; float:left; vertical-align:top; }
        #rightSide { width:45%; float:right; vertical-align:top; }

        .adjacent { display:inline-block; width:49%; vertical-align:top; text-align:center; padding:0 7px 0 7px; }

        #raceSelection { height:310px; overflow-y:auto; }

        #filterButtons { width:100%; margin-bottom:20px; text-align:center; }

        .switchFilter { padding:1px; display:inline-block; text-align:center; width:32%; background-color:#fff; font-weight:900; font-family:"Benton Sans",Helvetica,Arial,sans-serif; border:1px solid white; color:#000 !important; margin:0 !important; font-size:1em; border:1px solid #000; }
        .switchFilter:hover, { background-color:#4C4C39 !important; color:#fff !important; cursor:pointer; margin:0 !important; }

        #chartD { color:#3F88C5; text-align:left; }
        #chartR { color:#8C1B17; text-align:left; }
/*        #chartD .inBar { background-color:#3F88C5 !important; }
        #chartR .inBar { background-color:#8C1B17 !important; }*/
        #chartD .lb, #chartD .pubfin, #chartD .notepay, #chartD .noterec, #chartD .misc { background-color:#ABCEE8; }
        #chartD .pf { background-color:#5ca5c3; }
        #chartD .pp { background-color:#4f97c4; }
        #chartD .ind { background-color:#3f88c5; }
        #chartR .lb, #chartR .pubfin, #chartR .notepay, #chartR .noterec, #chartR .misc { background-color:#C68985; }
        #chartR .pf { background-color:#A5484D; }
        #chartR .pp { background-color:#A52129; }
        #chartR .ind { background-color:#8C1B17; }
        .bigBar { height:180px; }
        .bigNum { text-align:center; font-size:2em; }
        .subtotal { text-align:left; padding-bottom:7px; border-bottom:1px solid #ddd; font-size:0.9em; }
        .right { text-align:right; display:inline-block; width:48%; }
        .left { text-align:left; display:inline-block; width:48%; }
        .activeB { stroke-width:6px !important; stroke:#000 !important; }

        .offlink { text-align:center; display:none; }
        a { color:steelblue; }

        .cell { width:24%; display:inline-block; }

        #filter input:focus { width: 100% !important; }
        #filter input { width: 100% !important; font-family:"Benton Sans",Helvetica,Arial,sans-serif !important; border-radius:0 !important; }

        .switch { padding:1px; display:inline-block; text-align:left; width:100%; background-color:#fff; font-weight:900; font-family:"Benton Sans",Helvetica,Arial,sans-serif; border:1px solid white; color:#000 !important; margin:0 !important; font-size:.8em; }
        .switch:hover, .selected, .step:hover { background-color:#4C4C39 !important; color:#fff !important; cursor:pointer; margin:0 !important; }

        .ui-tooltip { border: 1px solid #000 !important; border-radius:0 !important; }
        .inBar div:hover { opacity:0.5; }
        .swatch { height:20px; width:20px; }

        #districtInfo { font-size:1.2em; font-weight:900; text-align:center; }
        #fundraising { font-weight:900; text-align:center; color:#bbbbbb; }

        #versus { text-align:center; vertical-align:top; margin-bottom:15px; }
        #versus div { display:inline-block; }
        .linebar { border-top:1px solid #000; width:20%; margin-bottom:5px; }

        .sift { display:inline-block; width:19% !important; text-align:center; padding:10px !important; margin:0 !important; font-size:.8em !important; opacity:.5;  border:0 !important;}
        .sift:hover, .selected2 { background-color:#fff !important; color:#333 !important; cursor:pointer; opacity:1; }
        .greyed { pointer-events:none; background-color:#ddd !important; color:#888; opacity:.3;  }
        .sift img { width:50px; display:block; text-align:center; margin-left:auto; margin-right:auto; }
        #main { margin-bottom:10px; margin-top:10px; text-align:center; }

        #candD, #candR { text-align:center; font-weight:900; }

        .donor .adjacent { width:24%; text-align:right; }
        .donor .adjacent:first-of-type { width:75% !important; text-align:left; }
        #listLabels { text-align:center; }
        #listLabels:hover{ cursor:pointer; opacity:0.5;  }
        #listD { font-size:0.8em; text-align:left; display:none; float:left; height:255px; overflow-y:auto; }
        #listR { font-size:0.8em; text-align:left; display:none; float:right; height:255px; overflow-y:auto; }
        .map { display:inline-block; width:48%; }
        .mapBox { /*display:inline-block; width:48%;*/ text-align:center; }
        .quantize { width:245px; text-align:center; margin-right:auto; margin-left: auto; }

        .districtName { font-weight:900; }

        .republican { color:#8C1B17; fill:#8C1B17 !important; pointer-events: all; font-weight:bold; }
        .r1 { background-color:#C68985; fill:#C68985 !important; color:white !important; pointer-events: all; font-weight:bold; }
        .r2 { background-color:#A5484D; fill:#A5484D !important; color:white !important; pointer-events: all; font-weight:bold; }
        .r3 { background-color:#A52129; fill:#A52129 !important; color:white !important; pointer-events: all; font-weight:bold; }
        .r4 { background-color:#8C1B17; fill:#8C1B17 !important; color:white !important; pointer-events: all; font-weight:bold; }
        .r0 { background-color:#8C1B17; fill:#8C1B17 !important; color:white !important; pointer-events: all; font-weight:bold; }
        .mid { background-color:#ddd; fill:#ddd !important; color:black !important; pointer-events: all; font-weight:bold; }
        .democrat { color:#3F88C5; fill:#3F88C5 !important; pointer-events: all; font-weight:bold; }
        .d1 { background-color:#ABCEE8; fill:#ABCEE8 !important; color:white !important; pointer-events: all; font-weight:bold; }
        .d2 { background-color:#5ca5c3; fill:#5ca5c3 !important; color:white !important; pointer-events: all; font-weight:bold; }
        .d3 { background-color:#4f97c4; fill:#4f97c4 !important; color:white !important; pointer-events: all; font-weight:bold; }
        .d4 { background-color:#3f88c5; fill:#3f88c5 !important; color:white !important; pointer-events: all; font-weight:bold; }
        .d0 { background-color:#3F88C5; fill:#3F88C5 !important; color:white !important; pointer-events: all; font-weight:bold; }
        .purple5 { fill:#4c1926; background-color:#4c1926; color:#ffffff; }
        .purple4 { fill:#693c46; background-color:#693c46; color:#ffffff; }
        .purple3 { fill:#865f67; background-color:#865f67; color:#ffffff; }
        .purple2 { fill:#a3858b; background-color:#a3858b; color:#ffffff; }
        .purple1 { fill:#C1ACB1; background-color:#C1ACB1; }

        @media (max-width:920px) {
        .mapBox { display:block; width:100%; }
        #wrapper { width:100%; }
/*        .adjacent { width:100%; }*/
        .bigNum { font-size:1.3em; }
        .bigBar { height:100px; }
        .cell { width:32%; display:inline-block; }
        .kill { display:none; }
        #candD, #candR { font-size:0.8em; }
        #raceSelection { height:200px; }
        #leftSide { width:100%; float:none; }
        #rightSide { width:100%; float:none; }
        }

        @media (max-width:550px) {
          .map { width:100%; }
          #mapMetroH, #mapMetroS { display:none; }
        }
    </style>
</head>
<body>

<div id="wrapper">

<div id="leg" class="raceType">
<!-- <div class="chartTitle">Campaign finance by legislative race, as of October 2016</div> -->

<div id="leftSide">
<div class="mapBox">
  <div id="mapStateS" class="map"><svg width="320" height="350" viewBox="0 0 500 550" preserveAspectRatio="xMidYMid"></svg></div>
  <div id="mapMetroS" class="map"><svg width="320" height="350" viewBox="0 0 500 550" preserveAspectRatio="xMidYMid"></svg></div>
  <div class="chatter">Total expenditures: Senate districts</div>
  <div class="quantize">
<span class='legend' id="aidQ">
  <nav class='legend clearfix'>
    <span style='background:#fff;'>Less</span>
    <span class="purple1"></span>
    <span class="purple2"></span>
    <span class="purple3"></span>
    <span class="purple4"></span>
    <span class="purple5"></span>
    <span style='background:#fff;'>More</span>
</span>
</div>
</div>

<div class="mapBox">
  <div id="mapStateH" class="map"><svg width="320" height="350" viewBox="0 0 500 550" preserveAspectRatio="xMidYMid"></svg></div>
  <div id="mapMetroH" class="map"><svg width="320" height="350" viewBox="0 0 500 550" preserveAspectRatio="xMidYMid"></svg></div>
  <div class="chatter">Total expenditures: House districts</div>
  <div class="quantize">
<span class='legend' id="aidQ">
  <nav class='legend clearfix'>
    <span style='background:#fff;'>Less</span>
    <span class="purple1"></span>
    <span class="purple2"></span>
    <span class="purple3"></span>
    <span class="purple4"></span>
    <span class="purple5"></span>
    <span style='background:#fff;'>More</span>
</span>
</div>
</div>

</div>

<div id="rightSide">

<div class="breaker"></div>

<div id="districtInfo"></div>

<div class="breaker"></div>

<div><span class="left">Candidate expenditures</span> <span class="right" id="candX"></span></div>
<div><span class="left">Independent expenditures</span> <span class="right" id="indX"></span></div>
<div><span class="left">Total expenditures</span> <span class="right" id="totalX"></span></div>

<div class="breaker"></div>

<div id="races" class="results">
<div id="fundraising">Candidate fundraising</div>
<!-- <div id="partyD" class="adjacent"></div>
<div id="partyR" class="adjacent"></div> -->
<!-- <div id="mapD" class="adjacent"><svg width="320" height="350" viewBox="0 0 500 550" preserveAspectRatio="xMidYMid"></svg></div>
<div id="mapR" class="adjacent"><svg width="320" height="350" viewBox="0 0 500 550" preserveAspectRatio="xMidYMid"></svg></div> -->
<!-- <div id="versus"><div class="linebar" style="border-left:1px solid #000; padding-bottom:6px; margin-top:3px;"></div><div class="vs">VS</div><div class="linebar" style="border-right:1px solid #000; padding-bottom:6px; margin-top:3px;"></div></div> -->

<!-- <div class="chartTitle">Candidate fundraising</div> -->

<div id="candD" class="adjacent"></div>
<div id="candR" class="adjacent"></div>
<div id="photoD" class="adjacent"></div>
<div id="photoR" class="adjacent"></div>
<div id="chartD" class="adjacent"></div>
<div id="chartR" class="adjacent"></div>
<div id="breakdownD" class="adjacent"></div>
<div id="breakdownR" class="adjacent"></div>
<div id="listLabels">
<!-- <h3 id="listDLabel" class="adjacent">DFL Donors</h3>
<h3 id="listRLabel" class="adjacent">GOP Donors</h3> -->
</div>
<div id="listD" class="adjacent"></div>
<div id="listR" class="adjacent"></div>
</div>
<div id="committees" class="results">

</div>

<div class="offlink"><a href="http://www.gis.leg.mn/iMaps/districts/" target="new_">Who represents me?</a></div>
<div id="filter"><input type="search" id="filter_box" placeholder="Search by district, candidate or chamber"></input></div>
<div class="breaker"></div>

<!-- <div id="filterButtons"><button class="switchFilter selected">All</button><button class="switchFilter">Watching</button><button class="switchFilter">Open</button></div> -->

<div id="raceSelection">
<div class="cell">District</div><div class="cell democrat">DFL</div><div class="cell republican">GOP</div><div class="cell kill">Chamber</div>
</div>
</div>


</div>

</div>

<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>
<script src="../_common_resources/charts/c3-master/c3.min.js"></script>
<script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="../_common_resources/charts/c3-master/c3.min.js"></script>
<script>

d3.csv("./data/races.csv", function(d) {
  return {
    race: d.district,
    chamber: d.chamber,
    democrat: d.democrat,
    dLast: d.dLast,
    dI: d.dI,
    republican: d.republican,
    rLast: d.rLast,
    rI: d.rI,
    candX: d.cand_xpend,
    indX: d.ind_xpend,
    totalX: d.total
  };
}, function(error, rows00) {

d3.csv("./data/candidates_master.csv", function(d) {
  return {
    id: d.CandRegNumb,
    district: d.District,
    party: d.PoliticalParty,
    first: d.CandFirstName,
    last: d.CandLastName,
    total: +d.TotReceipts,
    endcash: d.EndCash,
    indcontrib: d.IndContrib,
    ppcontrib: d.PPContrib,
    pfcontrib: d.PFContrib,
    lbcontrib: d.LbContrib,
    pubfin: d.PubFin,
    miscinc: d.MiscInc,
    notepayinc: d.NotePayInc,
    noterecinc: d.NoteRecInc,
    expend: d.TotalExpend,
    begin: d.BeginCash
  };
}, function(error, rows1) {

var dataRaces = rows00;
var dataFilings = rows1;

jQuery.fn.d3Click = function () {
  this.each(function (i, e) {
    var evt = document.createEvent("MouseEvents");
    evt.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);

    e.dispatchEvent(evt);
  });
};

jQuery.fn.d3Down = function () {
  this.each(function (i, e) {
    var evt = document.createEvent("MouseEvents");
    evt.initMouseEvent("mousedown", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);

    e.dispatchEvent(evt);
  });
};

jQuery.fn.d3Up = function () {
  this.each(function (i, e) {
    var evt = document.createEvent("MouseEvents");
    evt.initMouseEvent("mouseup", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);

    e.dispatchEvent(evt);
  });
};

function mapBuild(container, boxContainer, chartContainer, shape, race, geo, dataCompare, index) {

var width = 320,
    height = 400,
    centered;

if (geo=="us") { var projection = d3.geo.albersUsa().scale(700).translate([330, 200]); }
else if (geo=="mn") { var projection = d3.geo.albersUsa().scale(5037).translate([50, 970]); }
else if (geo=="metro") { var projection = d3.geo.mercator().scale([14800]).center([-92.384033,45.209134]); }

var path = d3.geo.path()
    .projection(projection);

var svg = d3.select(container + " svg")
    .attr("width", width)
    .attr("height", height);

svg.append("rect")
    .attr("class", "background")
    .attr("width", width)
    .attr("height", height);

var g = svg.append("g");

d3.json("shapefiles/" + shape, function(error, us) {

  g.append("g")
      .attr("class", "states")
    .selectAll("path")
      .data(us.features)
    .enter().append("path")
      .attr("d", path)
      .on("click", clicked)
      .attr("id", function(d) { var str = geo + "_" + d.properties.DISTRICT; return str.replace(new RegExp(" ", "g"),"-"); })
      .attr("precinctName", function(d){ return d.properties.DISTRICT; })
      .attr("class", function(d){
        var select = "";
        if (d.properties.DISTRICT == "01") { select = "activeB "; }
        for (var i=0; i<dataCompare.length; i++){
          if (d.properties.DISTRICT == dataCompare[i].race){
            if (dataCompare[i].totalX >= 500000) { return select + "purple5"; }
            if (dataCompare[i].totalX >= 375000) { return select + "purple4"; }
            if (dataCompare[i].totalX >= 250000) { return select + "purple3"; }
            if (dataCompare[i].totalX >= 125000) { return select + "purple2"; }
            if (dataCompare[i].totalX >= 0) { return select + "purple1"; }
          }
        }
            // return "mid";
        })
       .on("mousedown", function(d, i){  
        if (race == "house"){ dataSpill(d.properties.DISTRICT,"House"); } 
        else if (race == "senate") { dataSpill(d.properties.DISTRICT,"Senate"); }

       // $('.switch').hide();
       // var txt = d.properties.DISTRICT;
       // $("#filter_box").val(txt);
       // $('.switch').each(function(){
       //     if($(this).text().toUpperCase().indexOf(txt.toUpperCase()) != -1){
       //         $(this).show();
       //     }
       // });

       })
      .style("stroke-width", "1px")
      .style("stroke", "#fff")
      .call(d3.helper.tooltip(function(d, i){
        var color = "";
        var total = 0;
          for (var i=0; i<dataCompare.length; i++){
          if (d.properties.DISTRICT == dataCompare[i].race){
            if (dataCompare[i].totalX >= 500000) { color = "purple5"; total = dataCompare[i].totalX; }
            else if (dataCompare[i].totalX >= 375000) { color = "purple4"; total = dataCompare[i].totalX; }
            else if (dataCompare[i].totalX >= 250000) { color = "purple3"; total = dataCompare[i].totalX; }
            else if (dataCompare[i].totalX >= 125000) { color = "purple2"; total = dataCompare[i].totalX; }
            else if (dataCompare[i].totalX >= 0) { color = "purple1"; total = dataCompare[i].totalX; }
          }
        }

        return "<div class='districtName'> District " + d.properties.DISTRICT + "</div><div class='" + color + "'>" + d3.format("$,")(total) + " spent</div>";
      }));

  g.append("path")
      //.datum(topojson.mesh(us, us.features, function(a, b) { return a !== b; }))
      .attr("id", "state-borders")
      .attr("d", path);

});

var zoom = d3.behavior.zoom()
    .on("zoom",function() {
        g.attr("transform","translate("+ 
            d3.event.translate.join(",")+")scale("+d3.event.scale+")");
        g.selectAll("circle")
            .attr("d", path.projection(projection));
        g.selectAll("path")  
            .attr("d", path.projection(projection)); 

  });

$(".zoom, .switch, #close, .mapSwitch").click(function() {
  clicked2();
});

$(".mapSwitch").click(function() {
  $("#filter input").val("");
});

function clicked(d) {
  var x, y, k;

  if (d && centered !== d) {
    var centroid = path.centroid(d);
    x = centroid[0];
    y = centroid[1];
    k = 6;
    centered = d;
  } else {
    x = width / 2;
    y = height / 2;
    k = 3;
    centered = null;
  }

  d3.selectAll("#mapMetroH path, #mapStateH path, #mapMetroS path, #mapStateS path")
      .classed("activeB", false);

  g.selectAll("path")
      .classed("activeB", centered && function (d) { return d === centered; });
}

function clicked2(d) {
  var x, y, k;

  if (d && centered !== d) {
    var centroid = path.centroid(d);
    x = centroid[0];
    y = centroid[1];
    k = 1;
    centered = d;
  } else {
    x = width / 2;
    y = height / 2;
    k = 1;
    centered = null;
  }

  g.selectAll("path")
      .classed("faded", false)
      .classed("active", centered && function (d) { return d === centered; });
}

}

d3.helper = {};

d3.helper.tooltip = function(accessor){
    return function(selection){
        var tooltipDiv;
        var bodyNode = d3.select('body').node();
        selection.on("mouseover", function(d, i){
            // Clean up lost tooltips
            d3.select('body').selectAll('div.tooltip').remove();
            // Append tooltip
            tooltipDiv = d3.select('body').append('div').attr('class', 'tooltip');
            var absoluteMousePos = d3.mouse(bodyNode);
            tooltipDiv.style('left', (absoluteMousePos[0] + 10)+'px')
                .style('top', (absoluteMousePos[1] - 15)+'px')
                .style('position', 'absolute') 
                .style('z-index', 1001);
            // Add text using the accessor function
            var tooltipText = accessor(d, i) || '';
            // Crop text arbitrarily
            //tooltipDiv.style('width', function(d, i){return (tooltipText.length > 80) ? '300px' : null;})
            //    .html(tooltipText);
        })
        .on('mousemove', function(d, i) {
            // Move tooltip
            var absoluteMousePos = d3.mouse(bodyNode);
            tooltipDiv.style('left', (absoluteMousePos[0] + 10)+'px')
                .style('top', (absoluteMousePos[1] - 15)+'px');
            var tooltipText = accessor(d, i) || '';
            tooltipDiv.html(tooltipText);
        })
        .on("mouseout", function(d, i){
            // Remove tooltip
            tooltipDiv.remove();
        });

    };
};

//LOAD RACE LIST
function getRaces() {
    d3.select("#raceSelection").selectAll(".switch")
      .data(dataRaces).enter().append("div")
      .attr("class",function(d) { return "switch " + d.chamber; })
      .attr("chamber",function(d) { return d.chamber; })
      .attr("district",function(d) { return d.race; })
      .on("click",function(d){

      })
      .html(function(d){ 
        if (d.chamber == "House" || d.chamber == "Senate") { return "<div class='cell'>District " + d.race + "</div><div class='cell'>" + d.dLast + " " + d.dI + "</div><div class='cell'>" + d.rLast  + " " + d.rI + "</div><div class='cell kill'>" + d.chamber + "</div>"; }
      });

    $('#filter_box').keyup(function(i){
       $('.switch').hide();
       var txt = $('#filter_box').val();
       $('.switch').each(function(){
           if($(this).text().toUpperCase().indexOf(txt.toUpperCase()) != -1){
               $(this).show();
           }
       });
    });

    $(".sift").click(function()  { 
       $(".sift").removeClass("selected2");
       $(this).addClass("selected2");
       $(".switch").hide();
       $("." + $(this).attr("data")).show();
       $('#raceSelection').animate({scrollTop : 0},800);
       return false;
    });

    $(".switch").click(function()  { 
       $(".switch").removeClass("selected");
       $(this).addClass("selected");
       dataSpill($(this).attr("district"),$(this).attr("chamber"));

       var findDistrict = "mn_" + $(this).attr("district");
       var findMetro = "metro_" + $(this).attr("district");

       $("[id='" + findDistrict.replace(new RegExp(" ", "g"),"-") + "']").d3Down();
       $("[id='" + findDistrict.replace(new RegExp(" ", "g"),"-") + "']").d3Up();
       $("[id='" + findDistrict.replace(new RegExp(" ", "g"),"-") + "']").d3Click();
       $("[id='" + findMetro.replace(new RegExp(" ", "g"),"-") + "']").d3Down();
       $("[id='" + findMetro.replace(new RegExp(" ", "g"),"-") + "']").d3Up();
       $("[id='" + findMetro.replace(new RegExp(" ", "g"),"-") + "']").d3Click();

    });

    $("#listLabels").click(function()  { 
       $("#listR").slideToggle();
       $("#listD").slideToggle();
    });
}

getRaces();

//LOAD DONORS
function getDonors(container, candidate, party){
    d3.select(container).html("");

    d3.select(container).selectAll(".donor")
      .data(dataDonors.filter(function(d) { if (party == null) { return d.id == candidate; } else { if (getCandidates(d.id, true) == party) { return d.id; } } }).sort(function(a,b) {return b.amount-a.amount;})).enter().append("div")
      .attr("class",function(d) { return "donor"; })
      .on("click",function(d){ })
      .html(function(d){ 
        return "<div class='adjacent'>" + d.donor + "</div><div class='adjacent'>" + d3.format("$,.2f")(d.amount) + "</div>";
      });
}


//LOAD CHARTS
function drawChart(container, amount, bigTotal) {

var pct = d3.format("%")(amount[0] / bigTotal);
var indPCT = d3.format("%")(amount[1] / amount[0]);
var ppPCT = d3.format("%")(amount[2] / amount[0]);
var pfPCT = d3.format("%")(amount[3] / amount[0]);
var lbPCT = d3.format("%")(amount[4] / amount[0]);
var pubfinPCT = d3.format("%")(amount[5] / amount[0]);
var miscPCT = d3.format("%")(amount[6] / amount[0]);
var notepayPCT = d3.format("%")(amount[7] / amount[0]);
var noterecPCT = d3.format("%")(amount[8] / amount[0]);

$(container).html("<div class='bigNum'>" + d3.format("$,.2f")(amount[0]) + "</div><div class='bigBar'><div class='inBar' style='height:" + pct + "'><div class='ind' title='"  + d3.format("$,.2f")(amount[1]) +  " independent contributions' style='height:" + indPCT + "'></div><div class='pp' title='"  + d3.format("$,.2f")(amount[2]) +  " political party' style='height:" + ppPCT + "'></div><div class='pf' title='" + d3.format("$,.2f")(amount[3]) +  " political committees' style='height:" + pfPCT + "'></div><div class='lb' title='"  + d3.format("$,.2f")(amount[4]) +  " lobbyist contributions' style='height:" + lbPCT + "'></div><div class='pubfin' title='"  + d3.format("$,.2f")(amount[5]) +  " public financing' style='height:" + pubfinPCT + "'></div><div class='misc' title='"  + d3.format("$,.2f")(amount[6]) +  " miscellaneous' style='height:" + miscPCT + "'></div><div class='notepay' title='"  + d3.format("$,.2f")(amount[7]) +  " receipts loans payable' style='height:" + notepayPCT + "'></div><div class='noterec' title='"  + d3.format("$,.2f")(amount[8]) +  " noterec' style='height:" + noterecPCT + "'></div></div></div><div class='subtotal'><div class='left'>Begin 1/1/16</div><div class='right'>" +  d3.format("$,.2f")(amount[11]) + "</div></div><div class='subtotal'><div class='left'>Raised</div><div class='right'>+" +  d3.format("$,.2f")(amount[0]) + "</div></div><div class='subtotal'><div class='left'>Expenditures</div><div class='right'>-" + d3.format("$,.2f")(amount[9]) + "</div></div><div class='subtotal'><div class='left'>End 10/31/16</div><div class='right'>" + d3.format("$,.2f")(amount[10]) + "</div></div>");

 $( function() {
    $( document ).tooltip();
  } );

}

//LOAD CANDIDATES INFO
function getCandidates(district, party){
  var first, last, city, party, chamber, endcash, indcontrib, ppcontrib, pfcontrib, lbcontrib;
    for (var i=0; i < dataFilings.length; i++){
      if (dataFilings[i].district == district && dataFilings[i].party == party){
        party = dataFilings[i].party;
        first = dataFilings[i].first;
        last = dataFilings[i].last;
      }
    }

    if (party == "DFL"){ 
      $("#partyD").html(party); $("#candD").html("<div>" + first + " " + last + "</div>"); 
    } 
    else if (party == "GOP"){ 
      $("#partyR").html(party); $("#candR").html("<div>" + first + " " + last + "</div>");
    }
}

function getCandidateTotals(district,party){
 var total = [];
 var endcash, indcontrib, ppcontrib, pfcontrib, lbcontrib;
 for (var i=0; i < dataFilings.length; i++){
  
    if (dataFilings[i].district == district && dataFilings[i].party == party){  
        total[0] = Number(dataFilings[i].total);
        total[1] = Number(dataFilings[i].indcontrib);
        total[2] = Number(dataFilings[i].ppcontrib);
        total[3] = Number(dataFilings[i].pfcontrib);
        total[4] = Number(dataFilings[i].lbcontrib);
        total[5] = Number(dataFilings[i].pubfin);
        total[6] = Number(dataFilings[i].miscinc);
        total[7] = Number(dataFilings[i].notepayinc);
        total[8] = Number(dataFilings[i].noterecinc);
        total[9] = Number(dataFilings[i].expend);
        total[10] = Number(dataFilings[i].endcash);
        total[11] = Number(dataFilings[i].begin);
       }
 }

 return total;
}

//LOAD PARTIES
function dataSpill(race,chamber){

if (chamber == "House" || chamber == "Senate"){
$(".results").hide();
$("#races").show();

$("#districtInfo").html("District " + race + " (" + String(chamber).toUpperCase() + ")")

getCandidates(race,"DFL");
getCandidates(race,"GOP");

var bigTotal = getCandidateTotals(race,"DFL")[0] + getCandidateTotals(race,"GOP")[0];

drawChart("#chartD", getCandidateTotals(race,"DFL"), bigTotal);
drawChart("#chartR", getCandidateTotals(race,"GOP"), bigTotal);

var totalX;
var indX;
var candX;

for (var i=0; i<dataRaces.length; i++){
  if (race == dataRaces[i].race){
    totalX = dataRaces[i].totalX;
    indX = dataRaces[i].indX;
    candX = dataRaces[i].candX;
  }
}

$("#totalX").html(d3.format("$,")(totalX));
$("#indX").html(d3.format("$,")(indX));
$("#candX").html(d3.format("$,")(candX));

}
}

dataSpill("01","Senate");

mapBuild("#mapMetroS", "#infobox", "#chart", "mnsenate_metro.json", "senate", "metro", dataRaces, 0);
mapBuild("#mapStateS", "#infobox", "#chart", "mnsenate.json", "senate", "mn", dataRaces, 0);
mapBuild("#mapMetroH", "#infobox", "#chart", "mnleg_metro.json", "house", "metro", dataRaces, 0);
mapBuild("#mapStateH", "#infobox", "#chart", "mnleg.json", "house", "mn", dataRaces, 0);

var findDistrict = "mn_01";

//PARAMETER SWITCHES
$.urlParam = function(name){
  var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
  if (results != null) { return results[1]; }
  else { return 0; }
}

if ($.urlParam('race') != 0 && $.urlParam('chamber') != 0) { 
dataSpill($.urlParam('race'),$.urlParam('chamber'));
$("#leftSide").hide();
} 

});
});

</script>

</body>
</html>
